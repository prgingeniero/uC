
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://prg.engineer/4_4_8_Flatbuffers/">
      
      <link rel="icon" href="../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.2.5">
    
    
      
        <title>4 4 8 Flatbuffers - PRG</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2d9f7617.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-BY8HY373BD"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-BY8HY373BD",{page_path:e.pathname})})})</script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-BY8HY373BD"></script>


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tensorflow-lite-flatbuffer-manipulation-example" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href=".." title="PRG" class="md-header__button md-logo" aria-label="PRG" data-md-component="logo">
      
  <img src="../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PRG
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4 4 8 Flatbuffers
            
          </span>
        </div>
      </div>
    </div>
    
    
      <div class="md-header__option">
        <div class="md-select">
          
          <button class="md-header__button md-icon" aria-label="Seleccionar idioma">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24z"/></svg>
          </button>
          <div class="md-select__inner">
            <ul class="md-select__list">
              
                <li class="md-select__item">
                  <a href="/" hreflang="es" class="md-select__link">
                    Español
                  </a>
                </li>
                
                <li class="md-select__item">
                  <a href="/en/" hreflang="en" class="md-select__link">
                    English
                  </a>
                </li>
                
            </ul>
          </div>
        </div>
      </div>
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Pestañas" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  


  <li class="md-tabs__item">
    <a href="./" class="md-tabs__link md-tabs__link--active">
      4 4 8 Flatbuffers
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../home/" class="md-tabs__link">
      Deploying TinyML
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PRG" class="md-nav__button md-logo" aria-label="PRG" data-md-component="logo">
      
  <img src="../assets/logo.svg" alt="logo">

    </a>
    PRG
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          4 4 8 Flatbuffers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        4 4 8 Flatbuffers
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#software-installation" class="md-nav__link">
    Software installation
  </a>
  
    <nav class="md-nav" aria-label="Software installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-flatbuffer-python-library" class="md-nav__link">
    Install Flatbuffer Python Library
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-the-flatc-compiler" class="md-nav__link">
    Build the 'flatc' Compiler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetch-the-schema" class="md-nav__link">
    Fetch the Schema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-the-python-accessor-classes" class="md-nav__link">
    Generate the Python Accessor Classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-loading-and-saving" class="md-nav__link">
    Model Loading and Saving
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#download-an-example-model" class="md-nav__link">
    Download an Example Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-modify-and-save-a-model" class="md-nav__link">
    Load, Modify, and Save a Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-the-impact-of-your-changes" class="md-nav__link">
    Evaluating the impact of your changes
  </a>
  
    <nav class="md-nav" aria-label="Evaluating the impact of your changes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup-kws-infrastructure" class="md-nav__link">
    Setup KWS infrastructure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-your-models" class="md-nav__link">
    Test your Models
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../home/" class="md-nav__link">
        Deploying TinyML
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#software-installation" class="md-nav__link">
    Software installation
  </a>
  
    <nav class="md-nav" aria-label="Software installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-flatbuffer-python-library" class="md-nav__link">
    Install Flatbuffer Python Library
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-the-flatc-compiler" class="md-nav__link">
    Build the 'flatc' Compiler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fetch-the-schema" class="md-nav__link">
    Fetch the Schema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-the-python-accessor-classes" class="md-nav__link">
    Generate the Python Accessor Classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-loading-and-saving" class="md-nav__link">
    Model Loading and Saving
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#download-an-example-model" class="md-nav__link">
    Download an Example Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#load-modify-and-save-a-model" class="md-nav__link">
    Load, Modify, and Save a Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-the-impact-of-your-changes" class="md-nav__link">
    Evaluating the impact of your changes
  </a>
  
    <nav class="md-nav" aria-label="Evaluating the impact of your changes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup-kws-infrastructure" class="md-nav__link">
    Setup KWS infrastructure
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-your-models" class="md-nav__link">
    Test your Models
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
(function() {
  function addWidgetsRenderer() {
    var requireJsScript = document.createElement('script');
    requireJsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js';

    var mimeElement = document.querySelector('script[type="application/vnd.jupyter.widget-view+json"]');
    var jupyterWidgetsScript = document.createElement('script');
    var widgetRendererSrc = 'https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js';
    var widgetState;

    // Fallback for older version:
    try {
      widgetState = mimeElement && JSON.parse(mimeElement.innerHTML);

      if (widgetState && (widgetState.version_major < 2 || !widgetState.version_major)) {
        widgetRendererSrc = 'jupyter-js-widgets@*/dist/embed.js';
      }
    } catch(e) {}

    jupyterWidgetsScript.src = widgetRendererSrc;

    document.body.appendChild(requireJsScript);
    document.body.appendChild(jupyterWidgetsScript);
  }

  document.addEventListener('DOMContentLoaded', addWidgetsRenderer);
}());
</script>

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="tensorflow-lite-flatbuffer-manipulation-example">TensorFlow Lite Flatbuffer Manipulation Example</h1>
<p>It's possible to read, modify, and write TensorFlow Lite model files from Python. This notebook shows you how.</p>
<table align="left" class="tfo-notebook-buttons">
<td>
    <a target="_blank" href="https://colab.research.google.com/github/tinyMLx/colabs/blob/master/4-4-8-Flatbuffers.ipynb
"><img src="https://www.tensorflow.org/images/colab_logo_32px.png" />Run in Google Colab</a>
  </td>
<td>
    <a target="_blank" href="https://github.com/tinyMLx/colabs/blob/master/4-4-8-Flatbuffers.ipynb"><img src="https://www.tensorflow.org/images/GitHub-Mark-32px.png" />View source on GitHub</a>
  </td>
</table>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="software-installation">Software installation</h2>
<p>The goal is to build a set of Python classes that represent the types stored inside the TFL Flatbuffer files. To do this we need several dependencies:
 - The 'flatc' compiler, that converts the model format stored in a text schema to Python accessor classes.
 - The text schema itself, describing the model format.
 - The Flatbuffer Python library that the accessor classes rely on.</p>
<p>The 'flatc' compiler isn't available as a binary download, so we need to build it from source. The version has to match the Flatbuffer Python library on the system, or the resulting generated code won't work, since it will be trying to use a different API. The FB Python library is at version 1.12.0, so we make sure we download the tagged snapshot of the source at that same version from GitHub.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="install-flatbuffer-python-library">Install Flatbuffer Python Library</h3>
<p>We should already have version 1.12.0 by default on this Colab, but use pip to ensure it's installed, and then import it so it's available from Python.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>!pip install flatbuffers==1.12.0
import flatbuffers
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="build-the-flatc-compiler">Build the 'flatc' Compiler</h3>
<p>We need 'flatc' to generate the Python accessor classes we'll use to read and write the serialized files, and since it's not easily available as a binary, we grab the source code from the right version and build it directly. <strong>This will take a few minutes.</strong></p>
<p>Once the 'flatc' binary has been built, copy it to the <code>/usr/local/bin</code> folder so that it's easily accessible as a command.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code># Build and install the Flatbuffer compiler.
%cd /content/
!rm -rf flatbuffers*
!curl -L &quot;https://github.com/google/flatbuffers/archive/v1.12.0.zip&quot; -o flatbuffers.zip
!unzip -q flatbuffers.zip
!mv flatbuffers-1.12.0 flatbuffers
%cd flatbuffers
!cmake -G &quot;Unix Makefiles&quot; -DCMAKE_BUILD_TYPE=Release
!make -j 8
!cp flatc /usr/local/bin/
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="fetch-the-schema">Fetch the Schema</h3>
<p>The schema is <a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/schema/schema_v3.fbs">a text file that describes the layout of the model file format</a>, and it's part of the TensorFlow source code, so we need to fetch the latest version from GitHub.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>%cd /content/
!rm -rf tensorflow
%tensorflow_version 1.x
!wget https://github.com/tensorflow/tensorflow/archive/v2.4.1.zip
!unzip v2.4.1.zip &amp;&gt; 0
!mv tensorflow-2.4.1/ tensorflow/
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="generate-the-python-accessor-classes">Generate the Python Accessor Classes</h3>
<p>The 'flatc' compiler takes the information from the text schema, and creates Python code to read and write the data held inside the serialized Flatbuffer file. The Python classes are written into the <code>tflite</code> folder, with names like <code>Model.py</code>, and define classes like <code>ModelT</code> that contain members that you can use to read or write the contents of the data structures defined by the schema.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>!flatc --python --gen-object-api tensorflow/tensorflow/lite/schema/schema_v3.fbs
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="model-loading-and-saving">Model Loading and Saving</h3>
<p>These are some simple wrapper functions that demonstrate how to load data from a file, turn it into a <code>ModelT</code> Python object that can be modified, and then save it out to a new file.</p>
<p>We have to do a little bit of hackery with the Python search paths so that the class files we generated from the schema can be imported.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>import sys
# This hackery allows us to import the Python files we&#39;ve just generated.
sys.path.append(&quot;/content/tflite/&quot;)
import Model

def load_model_from_file(model_filename):
  with open(model_filename, &quot;rb&quot;) as file:
    buffer_data = file.read()
  model_obj = Model.Model.GetRootAsModel(buffer_data, 0)
  model = Model.ModelT.InitFromObj(model_obj)
  return model

def save_model_to_file(model, model_filename):
  builder = flatbuffers.Builder(1024)
  model_offset = model.Pack(builder)
  builder.Finish(model_offset, file_identifier=b&#39;TFL3&#39;)
  model_data = builder.Output()
  with open(model_filename, &#39;wb&#39;) as out_file:
    out_file.write(model_data)
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="download-an-example-model">Download an Example Model</h2>
<p>This pulls down a trained model from the speech commands tutorial that we can use to test the Flatbuffer loading code.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>!curl -O &#39;https://storage.googleapis.com/download.tensorflow.org/models/tflite/micro/speech_commands_model_2020_04_27.zip&#39;
!unzip speech_commands_model_2020_04_27.zip
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="load-modify-and-save-a-model">Load, Modify, and Save a Model</h2>
<p>The code below loads the float model, applies a small change to the float weights, and saves it out again. In this case we're just changing the contents of the weights, but any of the other properties of the model can be added, removed, or modified, including tensors, ops, and metadata.</p>
<p>I've found the easiest way to understand the syntax used and data available is to look at the generated classes in <code>tflite/</code> and <a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/schema/schema_v3.fbs">the text schema that describes the format</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code># Use numpy to make the manipulation of the weight arrays easier.
import numpy as np

# Load the float model we downloaded as a ModelT object.
model = load_model_from_file(&#39;/content/speech_commands_model/speech_commands_model_float.tflite&#39;)

# Loop through all the weights held in the model.
for buffer in model.buffers:
  # Skip missing or small weight arrays.
  if buffer.data is not None and len(buffer.data) &gt; 1024:
    # Pull the weight array from the model, and cast it to 32-bit floats since
    # we know that&#39;s the type for all the weights in this model. In a real
    # application we&#39;d need to check the data type from the tensor information
    # stored in the model.subgraphs
    original_weights = np.frombuffer(buffer.data, dtype=np.float32)

    # This is the line where the weights are altered.
    # Try replacing it with your own version, for example:
    # munged_weights = np.add(original_weights, 0.002)
    munged_weights = np.round(original_weights * (1/0.02)) * 0.02

    # Write the altered data back into the model.    
    buffer.data = munged_weights.tobytes()

# Save the ModelT object as a TFL Flatbuffer file.
save_model_to_file(model, &#39;/content/speech_commands_model/speech_commands_model_modified.tflite&#39;)
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="evaluating-the-impact-of-your-changes">Evaluating the impact of your changes</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="setup-kws-infrastructure">Setup KWS infrastructure</h3>
<p>To evaluate the impact of your changes on the accuracy of the speech model we need to load a test data set and some utility classes to read the files and convert them into the right input form for the network.</p>
<p><strong>The full dataset is several gigabytes in size, so it may take a few minutes to download.</strong></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>sys.path.append(&quot;/content/tensorflow/tensorflow/examples/speech_commands/&quot;)
import input_data
import models

# A comma-delimited list of the words you want to train for.
# The options are: yes,no,up,down,left,right,on,off,stop,go
# All the other words will be used to train an &quot;unknown&quot; label and silent
# audio data with no spoken words will be used to train a &quot;silence&quot; label.
WANTED_WORDS = &quot;yes,no&quot;

# The number of steps and learning rates can be specified as comma-separated
# lists to define the rate at each stage. For example,
# TRAINING_STEPS=12000,3000 and LEARNING_RATE=0.001,0.0001
# will run 12,000 training loops in total, with a rate of 0.001 for the first
# 8,000, and 0.0001 for the final 3,000.
TRAINING_STEPS = &quot;12000,3000&quot;
LEARNING_RATE = &quot;0.001,0.0001&quot;

# Calculate the total number of steps, which is used to identify the checkpoint
# file name.
TOTAL_STEPS = str(sum(map(lambda string: int(string), TRAINING_STEPS.split(&quot;,&quot;))))

# Calculate the percentage of &#39;silence&#39; and &#39;unknown&#39; training samples required
# to ensure that we have equal number of samples for each label.
number_of_labels = WANTED_WORDS.count(&#39;,&#39;) + 1
number_of_total_labels = number_of_labels + 2 # for &#39;silence&#39; and &#39;unknown&#39; label
equal_percentage_of_training_samples = int(100.0/(number_of_total_labels))
SILENT_PERCENTAGE = equal_percentage_of_training_samples
UNKNOWN_PERCENTAGE = equal_percentage_of_training_samples

# Constants which are shared during training and inference
PREPROCESS = &#39;micro&#39;
WINDOW_STRIDE =20
MODEL_ARCHITECTURE = &#39;tiny_conv&#39; # Other options include: single_fc, conv,
                      # low_latency_conv, low_latency_svdf, tiny_embedding_conv

# Constants used during training only
VERBOSITY = &#39;WARN&#39;
EVAL_STEP_INTERVAL = &#39;1000&#39;
SAVE_STEP_INTERVAL = &#39;1000&#39;

# Constants for training directories and filepaths
DATASET_DIR =  &#39;dataset/&#39;
LOGS_DIR = &#39;logs/&#39;
TRAIN_DIR = &#39;train/&#39; # for training checkpoints and other files.

SAMPLE_RATE = 16000
CLIP_DURATION_MS = 1000
WINDOW_SIZE_MS = 30.0
FEATURE_BIN_COUNT = 40
BACKGROUND_FREQUENCY = 0.8
BACKGROUND_VOLUME_RANGE = 0.1
TIME_SHIFT_MS = 100.0

DATA_URL = &#39;https://storage.googleapis.com/download.tensorflow.org/data/speech_commands_v0.02.tar.gz&#39;
VALIDATION_PERCENTAGE = 10
TESTING_PERCENTAGE = 10

model_settings = models.prepare_model_settings(
    len(input_data.prepare_words_list(WANTED_WORDS.split(&#39;,&#39;))),
    SAMPLE_RATE, CLIP_DURATION_MS, WINDOW_SIZE_MS,
    WINDOW_STRIDE, FEATURE_BIN_COUNT, PREPROCESS)
audio_processor = input_data.AudioProcessor(
    DATA_URL, DATASET_DIR,
    SILENT_PERCENTAGE, UNKNOWN_PERCENTAGE,
    WANTED_WORDS.split(&#39;,&#39;), VALIDATION_PERCENTAGE,
    TESTING_PERCENTAGE, model_settings, LOGS_DIR)
</code></pre></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>&gt;&gt; Downloading speech_commands_v0.02.tar.gz 100.0%
INFO:tensorflow:Successfully downloaded speech_commands_v0.02.tar.gz (2428923189 bytes)
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>import tensorflow as tf
# define our helper function to test the model accuracy
def test_model_accuracy(model_filename):
  with tf.compat.v1.Session() as sess:
    test_data, test_labels = audio_processor.get_data(
        -1, 0, model_settings, 0, 0,
        0, &#39;testing&#39;, sess)

  interpreter = tf.lite.Interpreter(model_filename)
  interpreter.allocate_tensors()

  input_index = interpreter.get_input_details()[0][&quot;index&quot;]

  output_index = interpreter.get_output_details()[0][&quot;index&quot;]
  model_output = interpreter.tensor(output_index)

  correct_predictions = 0
  for i in range(len(test_data)):
    current_input = test_data[i]
    current_label = test_labels[i]
    flattened_input = np.array(current_input.flatten(), dtype=np.float32).reshape(1, 1960)
    interpreter.set_tensor(input_index, flattened_input)
    interpreter.invoke()
    top_prediction = model_output()[0].argmax()
    if top_prediction == current_label:
      correct_predictions += 1

  print(&#39;Accuracy is %f%% (N=%d)&#39; % ((correct_predictions * 100) / len(test_data), len(test_data)))
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="test-your-models">Test your Models</h3>
<p>Finally we can test both the standard and your modified models!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Float model evaluation</strong></p>
<p>You should see ~91% accuracy with a 67KB model. Note: the exact accuracy may vary by a percent or two as it tests the model on a random sampling of the dataset and therefore sometimes gets particularly lucky or unlucky!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>!ls -lah /content/speech_commands_model/speech_commands_model_float.tflite
test_model_accuracy(&#39;/content/speech_commands_model/speech_commands_model_float.tflite&#39;)
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Modified model evaluation</strong></p>
<p>Test the impact of your changes!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><pre><span></span><code>!ls -lah /content/speech_commands_model/speech_commands_model_modified.tflite
test_model_accuracy(&#39;/content/speech_commands_model/speech_commands_model_modified.tflite&#39;)
</code></pre></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you'd like to try more modified models just scroll back up to the <strong>Load, Modify, and Save a Model</strong> section and re-run the modified model generation step and then skip back down to the above to re-test!</p>
</div>
</div>
</div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Pie">
      
      
        
        <a href="../home/" class="md-footer__link md-footer__link--next" aria-label="Siguiente: Deploying TinyML" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Siguiente
              </span>
              Deploying TinyML
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      © 2021 PRG
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "translations": {"clipboard.copy": "Copiar al portapapeles", "clipboard.copied": "Copiado al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}, "search": "../assets/javascripts/workers/search.bd0b6b67.min.js"}</script>
    
    
      <script src="../assets/javascripts/bundle.467223ff.min.js"></script>
      
        <script src="../javascripts/config.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>